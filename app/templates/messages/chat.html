{% extends "base.html" %}

{% block title %}Chat vá»›i {{ other_user.username }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <h3>ðŸ’¬ Chat vá»›i {{ other_user.username }}</h3>
    <div id="chat-box" class="chat-box border rounded p-3 mb-3" style="height: 400px; overflow-y: auto;">
        <!-- Tin nháº¯n sáº½ Ä‘Æ°á»£c load báº±ng AJAX -->
    </div>

    <!-- Form gá»­i tin nháº¯n -->
    <form id="chat-form" method="POST" action="{{ url_for('messages.send_message', user_id=other_user.id) }}">
        <div class="input-group">
            <input type="text" id="chat-input" name="content" class="form-control" placeholder="Nháº­p tin nháº¯n..." required>
            <button type="submit" class="btn btn-primary">Gá»­i</button>
        </div>
    </form>
</div>

<script>
    const chatBox = document.getElementById("chat-box");
    const chatForm = document.getElementById("chat-form");
    const chatInput = document.getElementById("chat-input");

    // HÃ m load tin nháº¯n
    function loadMessages() {
        fetch("{{ url_for('messages.get_messages', user_id=other_user.id) }}")
            .then(res => res.json())
            .then(data => {
                chatBox.innerHTML = "";
                data.messages.forEach(msg => {
                    const div = document.createElement("div");
                    div.className = "mb-2 " + (msg.sender_id == {{ current_user.id }} ? "text-end" : "");
                    div.innerHTML = `
                        <small class="text-muted">
                          ${msg.sender_id == {{ current_user.id }} ? "Báº¡n" : msg.sender}
                          (${msg.created_at})
                        </small><br>
                        <span class="p-2 rounded ${msg.sender_id == {{ current_user.id }} ? "bg-primary text-white" : "bg-light"}">
                          ${msg.content}
                        </span>
                    `;
                    chatBox.appendChild(div);
                });
                chatBox.scrollTop = chatBox.scrollHeight; // auto scroll xuá»‘ng cuá»‘i
            });
    }

    // Auto refresh 2s/láº§n
    setInterval(loadMessages, 2000);
    loadMessages();

    // Gá»­i tin nháº¯n báº±ng AJAX thay vÃ¬ reload cáº£ trang
    chatForm.addEventListener("submit", function(e) {
        e.preventDefault();
        fetch(chatForm.action, {
            method: "POST",
            body: new FormData(chatForm)
        }).then(() => {
            chatInput.value = "";
            loadMessages();
        });
    });
</script>
{% endblock %}
