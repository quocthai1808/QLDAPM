{# templates/candidate/profile.html #}
{% extends "base.html" %}

{% block title %}Hồ sơ ứng viên - JobNest{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 py-8">
  <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="bg-white shadow-lg rounded-2xl p-6 md:p-10">

      <!-- Header -->
      <div class="flex flex-col md:flex-row items-center gap-6 mb-6">
        <div class="relative w-28 h-28 md:w-36 md:h-36">
          {% if candidate.avatar %}
            <img id="avatar-img" src="{{ url_for('static', filename='uploads/' + candidate.avatar) }}" alt="Avatar" class="w-full h-full rounded-full object-cover border-4 border-white shadow-sm">
          {% else %}
            <img id="avatar-img" src="{{ url_for('static', filename='default-avatar.png') }}" alt="No Avatar" class="w-full h-full rounded-full object-cover border-4 border-white shadow-sm">
          {% endif %}
          <label for="avatar-upload" class="absolute -bottom-2 -right-2 bg-blue-600 text-white p-2 rounded-full cursor-pointer" title="Cập nhật ảnh đại diện">
            <i class="fa-solid fa-camera"></i>
            <input id="avatar-upload" name="avatar" type="file" accept="image/*" class="hidden" />
          </label>
        </div>

        <div class="flex-1 text-center md:text-left">
          <h1 class="text-2xl md:text-3xl font-extrabold text-gray-900">{{ candidate.full_name or "Chưa cập nhật" }}</h1>
          <p class="text-gray-600 mt-1">{{ candidate.title or 'Ứng viên' }} • <span>{{ candidate.location or '—' }}</span></p>

          <div class="mt-4 flex flex-wrap items-center gap-3">
            <a href="{{ url_for('candidate.edit_profile') }}" class="inline-flex items-center gap-2 px-4 py-2 bg-white border rounded-md shadow-sm hover:shadow">
              <i class="fa-solid fa-pen text-sm text-gray-600"></i>
              <span class="text-sm font-medium text-gray-700">Chỉnh sửa hồ sơ</span>
            </a>

            <button id="open-builder" class="inline-flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-md shadow hover:bg-blue-700">
              <i class="fa-solid fa-file-circle-plus"></i>
              <span class="text-sm font-medium">Xây dựng CV</span>
            </button>

            <a id="download-latest" href="#" class="inline-flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-md shadow hover:bg-green-700 hidden">
              <i class="fa-solid fa-download"></i>
              <span class="text-sm font-medium">Tải CV mới nhất</span>
            </a>
          </div>
        </div>

        <div class="w-full md:w-auto text-right">
          <div class="text-sm text-gray-500">Được tạo: <span class="font-medium">{{ candidate.created_at.strftime('%d/%m/%Y') if candidate.created_at else '—' }}</span></div>
        </div>
      </div>

      <!-- Main -->
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Quick info -->
        <aside class="bg-gray-50 p-4 rounded-xl border border-gray-100">
          <h3 class="font-semibold text-gray-800 mb-3">Thông tin nhanh</h3>
          <ul class="text-sm text-gray-600 space-y-2">
            <li><strong>Email:</strong> {{ candidate.email or '—' }}</li>
            <li><strong>Điện thoại:</strong> {{ candidate.phone or '—' }}</li>
            <li><strong>Địa chỉ:</strong> {{ candidate.address or '—' }}</li>
          </ul>
        </aside>

        <!-- Templates + Preview -->
        <div class="lg:col-span-2">
          <div class="bg-gradient-to-r from-white via-blue-50 to-indigo-50 p-6 rounded-xl mb-6">
            <div class="flex items-center justify-between mb-4">
              <div>
                <h3 class="text-lg font-bold text-gray-900">Chọn Template CV</h3>
                <p class="text-sm text-gray-600">Chọn mẫu phù hợp, sau đó chỉnh chi tiết trong trình dựng CV.</p>
              </div>
              <div class="text-sm text-gray-500">Hiện có <span id="template-count" class="font-medium">3</span> mẫu</div>
            </div>

            <div id="template-list" class="grid grid-cols-1 sm:grid-cols-3 gap-4">
              <button data-template="modern" class="template-card group p-4 rounded-lg border border-transparent hover:border-blue-300 bg-white shadow-sm text-left">Modern</button>
              <button data-template="creative" class="template-card group p-4 rounded-lg border border-transparent hover:border-green-300 bg-white shadow-sm text-left">Creative</button>
              <button data-template="professional" class="template-card group p-4 rounded-lg border border-transparent hover:border-purple-300 bg-white shadow-sm text-left">Professional</button>
            </div>

            <div class="mt-4 flex gap-3">
              <button id="quick-preview" class="px-4 py-2 bg-white border rounded-md">Xem nhanh</button>
              <div id="template-tags" class="ml-auto text-xs text-gray-500"></div>
            </div>
          </div>

          <div id="cv-preview" class="bg-white p-6 rounded-xl shadow-sm hidden">
            <div class="flex items-start justify-between mb-4">
              <h4 class="text-lg font-semibold text-gray-800">Xem trước CV</h4>
              <div class="text-sm text-gray-500">Mẫu: <span id="preview-template-name" class="font-medium">Modern</span></div>
            </div>

            <div id="preview-content" class="prose max-w-none text-gray-700"></div>

            <div class="mt-4 flex justify-end gap-2">
              <button id="edit-in-builder" class="px-4 py-2 bg-gray-50 border rounded-md">Chỉnh chi tiết</button>
              <button id="export-pdf" class="px-4 py-2 bg-green-600 text-white rounded-md">Tạo & Tải PDF</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Footer -->
      <div class="mt-8 text-center text-gray-500 text-sm">
        © 2025. All Rights Reserved. JobNest Vietnam JSC.
      </div>

    </div>
  </div>

  <!-- Builder Modal -->
  <div id="cv-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center z-50 p-4" aria-hidden="true">
    <div class="bg-white rounded-2xl p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto" role="dialog" aria-modal="true" aria-labelledby="cv-modal-title">
      <div class="flex items-center justify-between mb-6">
        <h3 id="cv-modal-title" class="text-2xl font-bold text-gray-900">Xây dựng CV</h3>
        <button id="close-modal" class="text-gray-500 hover:text-gray-700 text-2xl" aria-label="Đóng">&times;</button>
      </div>

      <form id="cv-form" class="space-y-4">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() if csrf_token is defined else '' }}">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <input id="cv-fullname" name="full_name" type="text" placeholder="Họ và tên" class="p-3 border rounded-lg" value="{{ candidate.full_name or '' }}">
          <input id="cv-email" name="email" type="email" placeholder="Email" class="p-3 border rounded-lg" value="{{ candidate.email or '' }}">
          <input id="cv-phone" name="phone" type="tel" placeholder="Số điện thoại" class="p-3 border rounded-lg" value="{{ candidate.phone or '' }}">
          <input id="cv-address" name="address" type="text" placeholder="Địa chỉ" class="p-3 border rounded-lg" value="{{ candidate.address or '' }}">
        </div>

        <div>
          <label class="text-sm font-medium text-gray-700">Mục tiêu nghề nghiệp</label>
          <textarea id="cv-objective" name="career_objective" rows="3" class="w-full p-3 border rounded-lg">{{ candidate.career_objective or '' }}</textarea>
        </div>

        <div>
          <label class="text-sm font-medium text-gray-700">Kinh nghiệm</label>
          <textarea id="cv-experience" name="experience" rows="4" class="w-full p-3 border rounded-lg">{{ candidate.experience or '' }}</textarea>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <input id="cv-certifications" name="certifications" type="text" placeholder="Chứng chỉ" class="p-3 border rounded-lg" value="{{ candidate.certifications or '' }}">
          <input id="cv-hobbies" name="hobbies" type="text" placeholder="Sở thích" class="p-3 border rounded-lg" value="{{ candidate.hobbies or '' }}">
        </div>

        <div class="flex items-center justify-end gap-3 pt-2">
          <button type="button" id="preview-btn" class="px-4 py-2 bg-gray-50 border rounded-md">Xem trước</button>
          <button type="button" id="close-modal-btn" class="px-4 py-2 bg-white border rounded-md">Hủy</button>
          <button type="submit" id="submit-cv-btn" class="px-4 py-2 bg-blue-600 text-white rounded-md">Tạo & Tải CV</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Toast container -->
  <div id="toast-container" class="fixed top-6 right-6 z-60 flex flex-col gap-2"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
  const qs = s => document.querySelector(s);
  const qsa = s => Array.from(document.querySelectorAll(s));

  // State
  let selectedTemplate = localStorage.getItem('jn_selected_template') || 'modern';
  qs('#template-tags').textContent = selectedTemplate.toUpperCase();

  // Template selection
  qs('#template-list').addEventListener('click', (e) => {
    const btn = e.target.closest('[data-template]');
    if (!btn) return;
    selectedTemplate = btn.getAttribute('data-template');
    localStorage.setItem('jn_selected_template', selectedTemplate);
    qsa('.template-card').forEach(c => c.classList.remove('ring-2', 'ring-blue-200'));
    btn.classList.add('ring-2', 'ring-blue-200');
    qs('#template-tags').textContent = selectedTemplate.toUpperCase();
  });

  // Modal open/close
  function openModal(){ qs('#cv-modal').classList.remove('hidden'); }
  function closeModal(){ qs('#cv-modal').classList.add('hidden'); }
  qs('#open-builder').addEventListener('click', openModal);
  qs('#close-modal').addEventListener('click', closeModal);
  qs('#close-modal-btn').addEventListener('click', closeModal);

  // Quick preview
  function collectFormData(){
    return {
      full_name: qs('#cv-fullname')?.value || '{{ candidate.full_name or "" }}',
      email: qs('#cv-email')?.value || '{{ candidate.email or "" }}',
      phone: qs('#cv-phone')?.value || '{{ candidate.phone or "" }}',
      career_objective: qs('#cv-objective')?.value || '{{ candidate.career_objective or "" }}',
      experience: qs('#cv-experience')?.value || '{{ candidate.experience or "" }}',
      education: qs('#cv-education')?.value || '{{ candidate.education or "" }}',
      skills: qs('#cv-skills')?.value || '{{ candidate.skills or "" }}',
      certifications: qs('#cv-certifications')?.value || '{{ candidate.certifications or "" }}',
      hobbies: qs('#cv-hobbies')?.value || '{{ candidate.hobbies or "" }}'
    };
  }

  function escapeHtml(unsafe){ return (unsafe+'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
  function nl2br(str){ return (str||'').replace(/\n/g, '<br/>'); }

  function buildPreview(data){
    const accent = selectedTemplate === 'creative' ? '#0ea5a4' : (selectedTemplate === 'professional' ? '#7c3aed' : '#2563eb');
    return `
      <div class="p-4 rounded-lg" style="border-left:4px solid ${accent}">
        <h2 class="text-xl font-bold mb-1">${escapeHtml(data.full_name || 'Chưa điền')}</h2>
        <p class="text-sm text-gray-600 mb-3">${escapeHtml(data.email || '')} • ${escapeHtml(data.phone || '')}</p>
        <h3 class="font-semibold mt-3">Mục tiêu</h3>
        <p class="text-sm text-gray-700">${nl2br(escapeHtml(data.career_objective || 'Chưa điền'))}</p>
        <h3 class="font-semibold mt-3">Kinh nghiệm</h3>
        <p class="text-sm text-gray-700">${nl2br(escapeHtml(data.experience || 'Chưa điền'))}</p>
      </div>
    `;
  }

  qs('#quick-preview').addEventListener('click', () => {
    const data = collectFormData();
    qs('#preview-template-name').textContent = selectedTemplate.charAt(0).toUpperCase() + selectedTemplate.slice(1);
    qs('#preview-content').innerHTML = buildPreview(data);
    qs('#cv-preview').classList.remove('hidden');
    window.scrollTo({ top: qs('#cv-preview').offsetTop - 20, behavior: 'smooth' });
  });

  qs('#preview-btn').addEventListener('click', () => {
    const data = collectFormData();
    qs('#preview-template-name').textContent = selectedTemplate.charAt(0).toUpperCase() + selectedTemplate.slice(1);
    qs('#preview-content').innerHTML = buildPreview(data);
    qs('#cv-preview').classList.remove('hidden');
    closeModal();
    window.scrollTo({ top: qs('#cv-preview').offsetTop - 20, behavior: 'smooth' });
  });

  // Submit CV -> /cv/create
  qs('#cv-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const btn = qs('#submit-cv-btn');
    btn.disabled = true; btn.textContent = 'Đang xử lý...';

    const fd = new FormData();
    const data = collectFormData();
    fd.append('template', selectedTemplate);
    for (const k in data) fd.append(k, data[k]);

    try {
      const res = await fetch('/cv/create', { method: 'POST', body: fd });
      if (!res.ok) {
        const j = await res.json();
        alert(j.message || 'Lỗi khi tạo CV');
        return;
      }
      const blob = await res.blob();
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `CV-${data.full_name || 'candidate'}.pdf`;
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);

      // show download-latest link
      qs('#download-latest').classList.remove('hidden');
      qs('#download-latest').href = '/cv/download-latest';
    } catch (err) {
      console.error(err);
      alert('Lỗi khi tạo CV');
    } finally {
      btn.disabled = false; btn.textContent = 'Tạo & Tải CV';
    }
  });

  // avatar upload (uses existing candidate route /candidate/upload-avatar)
  qs('#avatar-upload').addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    if (!file.type.startsWith('image/')) { alert('Vui lòng chọn file ảnh'); return; }
    if (file.size > 2 * 1024 * 1024) { alert('Kích thước tối đa 2MB'); return; }

    qs('#avatar-img').src = URL.createObjectURL(file);
    const fd = new FormData(); fd.append('avatar', file);

    try {
      const res = await fetch('/candidate/upload-avatar', { method: 'POST', body: fd });
      const j = await res.json();
      if (j.success) alert('Cập nhật ảnh thành công');
      else alert(j.message || 'Không thể upload ảnh');
    } catch (err) {
      console.error(err); alert('Lỗi mạng khi upload ảnh');
    }
  });

  // edit-in-builder opens modal
  qs('#edit-in-builder').addEventListener('click', openModal);

});
</script>
{% endblock %}
